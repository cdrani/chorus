name: Daily Release

on:
  schedule:
    - cron: '30 9 * * *'

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Develop Branch Check
        run: |
          if [ "$GITHUB_REF" != "refs/heads/develop" ]; then
            echo "Not on the develop branch. Exiting workflow."
            exit 0
          fi
          
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0
      
      - name: Semver Info
        id: semver
        uses: jossef/action-semantic-release-info@v2.1.0
          
      - name: Early Exit
        run: |
          version="${{ steps.semver.outputs.version }}"
          if [[ $version == '' ]]; then
            echo "No version update needed. Exiting workflow."
            exit 0
          fi  
          
      - name: Update Version
        run: jq --arg version "${{ steps.semver.outputs.version }}" '.version = $version' manifest.json > tmp && mv tmp manifest.json

      - name: Commit Changes
        run: |
          git config --local user.name "Github Action"
          git config user.email "action@github.com"
          git commit -a -m "docs: bump version to v${{ steps.semver.outputs.git_tag }}"
          git tag ${{ steps.semver.outputs.git_tag }}

      - name: Push Changes
        uses: ad-m/github-push-action@master
        with:
          branch: ${{ github.ref }}
          tags: true

      - name: Archive Extension Files
        run: zip -r Chorus.zip . -x "*.git*" "*.md"

      - name: Create Release Archive & Notes
        uses: ncipollo/release-action@v1.12.0
        with:
          artifacts: 'Chorus.zip'
          tag: $${{ steps.semver.outputs.git_tag }}
          name: ${{ steps.semver.outputs.git_tag }}
          body: ${{ steps.semver.outputs.notes }}
